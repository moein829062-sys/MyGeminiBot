from pyrogram import Client, filters
from pyrogram.types import Message
import google.generativeai as genai
from flask import Flask
from threading import Thread
import json
import os
import asyncio

# ================= ØªÙ†Ø¸ÛŒÙ…Ø§Øª (Ø§ÛŒÙ†Ø¬Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯) =================
API_ID = 14303003               # Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ú©Ù†ÛŒØ¯ (Ø¹Ø¯Ø¯)
API_HASH = '88650c7e9d9705c8fa0059b5fcd4716d'     # Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ú©Ù†ÛŒØ¯ (Ù…ØªÙ† Ø¯Ø§Ø®Ù„ Ú©ÙˆØªÛŒØ´Ù†)
GEMINI_KEY = 'AIzaSyA-rn6mdKgUq3kw-IRfwrBarYSQqzLwti0' # Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ú©Ù†ÛŒØ¯

# Ù†Ø§Ù… ÙØ§ÛŒÙ„ÛŒ Ú©Ù‡ Ù„ÛŒØ³Øª Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§ÛŒ ØªØ­Øª Ù†Ø¸Ø± Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒÚ©Ù†Ø¯
DB_FILE = "watched_channels.json"
# ==============================================================

# ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ
genai.configure(api_key=GEMINI_KEY)
model = genai.GenerativeModel('gemini-pro')

# ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø±Ø¨Ø§Øª ØªÙ„Ú¯Ø±Ø§Ù…
app = Client("my_super_agent", api_id=API_ID, api_hash=API_HASH)

# --- ØªÙˆØ§Ø¨Ø¹ Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ (Ø­Ø§ÙØ¸Ù‡ Ø±Ø¨Ø§Øª) ---
def load_watched_channels():
    if not os.path.exists(DB_FILE): return []
    try:
        with open(DB_FILE, 'r') as f: return json.load(f)
    except: return []

def save_watched_channel(chat_id):
    channels = load_watched_channels()
    if chat_id not in channels:
        channels.append(chat_id)
        with open(DB_FILE, 'w') as f: json.dump(channels, f)
        return True
    return False

def remove_watched_channel(chat_id):
    channels = load_watched_channels()
    if chat_id in channels:
        channels.remove(chat_id)
        with open(DB_FILE, 'w') as f: json.dump(channels, f)
        return True
    return False

# --- ÙˆØ¨â€ŒØ³Ø±ÙˆØ± Ø¨Ø±Ø§ÛŒ Ø¨ÛŒØ¯Ø§Ø± Ù…Ø§Ù†Ø¯Ù† Ø¯Ø± Ù‡Ø§Ø³Øª Ø±Ø§ÛŒÚ¯Ø§Ù† ---
server = Flask(__name__)
@server.route('/')
def home(): return "Bot is Alive and Watching!"
def run_server(): server.run(host="0.0.0.0", port=8080)

# ==========================================================
# Ø¨Ø®Ø´ Û±: ÙØ±Ù…Ø§Ù†Ø¯Ù‡ÛŒ (Ù¾ÛŒØ§Ù… Ø¨Ù‡ Saved Messages)
# ==========================================================
@app.on_message(filters.me & filters.text & ~filters.forwarded)
async def commander(client, message: Message):
    text = message.text
    
    # Ø¯Ø³ØªÙˆØ±: /watch @channel
    if text.startswith("/watch"):
        try:
            target = text.split()[1]
            chat = await client.get_chat(target)
            if save_watched_channel(chat.id):
                await message.edit(f"âœ… Ú©Ø§Ù†Ø§Ù„ **{chat.title}** Ø¨Ù‡ Ù„ÛŒØ³Øª Ø¬Ø§Ø³ÙˆØ³ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯!")
            else:
                await message.edit("âš ï¸ Ù‚Ø¨Ù„Ø§Ù‹ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù‡ Ø§Ø³Øª.")
        except: await message.edit("âŒ Ú©Ø§Ù†Ø§Ù„ ÛŒØ§ÙØª Ù†Ø´Ø¯ ÛŒØ§ Ø¯Ø³ØªÙˆØ± Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª.")

    # Ø¯Ø³ØªÙˆØ±: /unwatch @channel
    elif text.startswith("/unwatch"):
        try:
            target = text.split()[1]
            chat = await client.get_chat(target)
            if remove_watched_channel(chat.id):
                await message.edit(f"ğŸ—‘ Ù†Ø¸Ø§Ø±Øª Ø¨Ø± **{chat.title}** Ù„ØºÙˆ Ø´Ø¯.")
            else:
                await message.edit("âš ï¸ Ø§ÛŒÙ† Ú©Ø§Ù†Ø§Ù„ Ø¯Ø± Ù„ÛŒØ³Øª Ù†Ø¨ÙˆØ¯.")
        except: await message.edit("âŒ Ø®Ø·Ø§.")

    # Ø¯Ø³ØªÙˆØ±: /list
    elif text == "/list":
        ids = load_watched_channels()
        await message.edit(f"ğŸ“‹ **Ù„ÛŒØ³Øª ØªØ­Øª Ù†Ø¸Ø±:**\n{ids}")

    # Ø¯Ø³ØªÙˆØ± Ø¬Ø³ØªØ¬Ùˆ: /find Ú©Ù„Ù…Ù‡
    elif text.startswith("/find"):
        query = text.replace("/find", "").strip()
        await message.edit(f"ğŸ” Ø¯Ø± Ø­Ø§Ù„ Ø¬Ø³ØªØ¬ÙˆÛŒ Ø³Ø±Ø§Ø³Ø±ÛŒ Ø¨Ø±Ø§ÛŒ: {query}...")
        results = ""
        count = 0
        try:
            async for item in client.search_global(query, limit=10):
                if item.document or item.text: # ÙÙ‚Ø· ÙØ§ÛŒÙ„ ÛŒØ§ Ù…ØªÙ†
                    link = item.link if item.link else "Ù„ÛŒÙ†Ú© Ø®ØµÙˆØµÛŒ"
                    src = item.chat.title if item.chat else "Ù†Ø§Ø´Ù†Ø§Ø³"
                    typ = "ğŸ“„ ÙØ§ÛŒÙ„" if item.document else "ğŸ“ Ù…ØªÙ†"
                    results += f"{typ} | {src}\nğŸ”— {link}\n\n"
                    count += 1
            
            if count > 0: await client.send_message("me", f"ğŸ“Š Ù†ØªØ§ÛŒØ¬:\n{results}")
            else: await message.edit("âŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.")
        except Exception as e: await message.edit(f"Ø®Ø·Ø§: {e}")

# ==========================================================
# Ø¨Ø®Ø´ Û²: Ø§Ø¬Ø±Ø§ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± (Ù…Ø§Ù†ÛŒØªÙˆØ±ÛŒÙ†Ú¯)
# ==========================================================
@app.on_message(filters.channel)
async def auto_monitor(client, message: Message):
    watched = load_watched_channels()
    if message.chat.id in watched:
        # Ø§Ú¯Ø± Ù…ØªÙ† Ø¨ÙˆØ¯ -> Ø¨Ø¯Ù‡ Ø¨Ù‡ Ø¬Ù…Ù†Ø§ÛŒ
        if message.text:
            try:
                prompt = f"Ø§ÛŒÙ† Ù…ØªÙ† Ø±Ø§ Ø¨Ø§Ø²Ù†ÙˆÛŒØ³ÛŒ Ú©Ù†ØŒ Ù„ÛŒÙ†Ú© Ù‡Ø§ÛŒØ´ Ø±Ø§ Ø­Ø°Ù Ú©Ù† Ùˆ Ø¬Ø°Ø§Ø¨ Ø¨Ù†ÙˆÛŒØ³:\n{message.text}"
                res = model.generate_content(prompt)
                await client.send_message(MY_DESTINATION_CHANNEL, res.text)
            except: pass
        
        # Ø§Ú¯Ø± ÙØ§ÛŒÙ„/Ø¹Ú©Ø³/ÙˆÛŒØ¯ÛŒÙˆ Ø¨ÙˆØ¯ -> Ù…Ø³ØªÙ‚ÛŒÙ… Ú©Ù¾ÛŒ Ú©Ù† (ÛŒØ§ Ú©Ù¾Ø´Ù† Ø±Ùˆ Ø¹ÙˆØ¶ Ú©Ù†)
        elif message.media:
            # Ø§ÛŒÙ†Ø¬Ø§ ÙÙ‚Ø· Ú©Ù¾ÛŒ Ù…ÛŒÚ©Ù†ÛŒÙ…. Ø§Ú¯Ø± Ø¨Ø®ÙˆØ§Ù‡ÛŒ Ú©Ù¾Ø´Ù† Ø¹ÙˆØ¶ Ø´ÙˆØ¯ Ø¨Ø§ÛŒØ¯ Ø¨Ù‡ Ø¬Ù…Ù†Ø§ÛŒ Ø¨Ø¯ÛŒ
            await message.copy(MY_DESTINATION_CHANNEL)

if __name__ == '__main__':
    Thread(target=run_server).start()
    app.run()
